<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1:1 Chat with Room Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .chat-container {
      margin-top: 20px;
    }
    textarea {
      width: 100%;
      resize: none;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }
    .room-item {
      cursor: pointer;
      padding: 5px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
    }
    .room-item:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
<h1>1:1 Chat Application</h1>

<!-- User Info -->
<div>
  <label for="caregiverInfo">Your Nickname:</label>
  <input type="text" id="caregiverInfo" placeholder="Your nickname">
</div>
<div>
  <label for="entrustedInfo">Partner's Nickname:</label>
  <input type="text" id="entrustedInfo" placeholder="Partner's nickname">
</div>

<!-- Match and Connect -->
<div>
  <button id="createRoomBtn">Create Room</button>
  <button id="joinRoomBtn">Fetch Chat Rooms</button>
</div>

<!-- Status -->
<div id="statusMessage" class="error"></div>

<!-- Chat Rooms -->
<div id="chatRoomsContainer" style="margin-top: 20px;"></div>

<!-- Chat -->
<div class="chat-container" id="chatContainer" style="display:none;">
  <h2>Chat Room</h2>
  <p>Chat Room ID: <span id="chatRoomNumber"></span></p>
  <textarea id="chatMessageInfos" rows="15" readonly placeholder="Messages will appear here"></textarea>
  <input type="text" id="messageInput" placeholder="Enter your message">
  <button id="sendMessageBtn">Send Message</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script>
  const stompClients = {}; // Store WebSocket clients for each room
  let chatRoomNumber = null; // Currently active chat room

  // HTML Elements
  const caregiverInfoInput = document.getElementById('caregiverInfo');
  const entrustedInfoInput = document.getElementById('entrustedInfo');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const chatRoomsContainer = document.getElementById('chatRoomsContainer');
  const chatContainer = document.getElementById('chatContainer');
  const chatRoomNumberSpan = document.getElementById('chatRoomNumber');
  const chatMessageInfos = document.getElementById('chatMessageInfos');
  const messageInput = document.getElementById('messageInput');
  const sendMessageBtn = document.getElementById('sendMessageBtn');
  const statusMessage = document.getElementById('statusMessage');

  // Update Status Message
  function updateStatus(message, isSuccess = false) {
    statusMessage.textContent = message;
    statusMessage.className = isSuccess ? 'success' : 'error';
  }

  // Create Room
  createRoomBtn.addEventListener('click', () => {
    const caregiverInfo = caregiverInfoInput.value.trim();
    const entrustedInfo = entrustedInfoInput.value.trim();

    if (!caregiverInfo || !entrustedInfo) {
      updateStatus('Please enter both your nickname and your partner\'s nickname!');
      return;
    }

    // API 요청으로 채팅방 생성
    fetch('/api/v1/match', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        caregiverEmail: caregiverInfo,
        entrustedEmail: entrustedInfo
      })
    })
            .then(response => response.json())
            .then(data => {
              if (data.responseCode === "SUCCESS") {
                chatRoomNumber = data.result;
                chatRoomNumberSpan.textContent = chatRoomNumber;
                updateStatus(`Chat room created: ${chatRoomNumber}`, true);

                // 채팅방 자동 WebSocket 연결 및 구독
                connectToWebSocketForRoom(chatRoomNumber);

                // 채팅 내역 불러오기
                loadChatMessages(chatRoomNumber);
              } else {
                updateStatus(`Failed to create chat room: ${data.responseCode}`);
              }
            })
            .catch(error => {
              console.error('Error during room creation:', error);
              updateStatus('Error during room creation.');
            });
  });

  // Fetch and Display Chat Rooms
  joinRoomBtn.addEventListener('click', () => {
    const caregiverInfo = caregiverInfoInput.value.trim();

    if (!caregiverInfo) {
      updateStatus('Please enter your nickname!');
      return;
    }

    fetch(`/api/v1/match?userEmail=${encodeURIComponent(caregiverInfo)}`)
            .then(response => response.json())
            .then(data => {
              if (data.responseCode === "SUCCESS") {
                displayChatRooms(data.result);
                updateStatus('Fetched chat rooms successfully.', true);
              } else {
                updateStatus(`Failed to fetch chat rooms: ${data.responseCode}`);
              }
            })
            .catch(error => {
              console.error('Error fetching chat rooms:', error);
              updateStatus('Error fetching chat rooms.');
            });
  });

  // Display Chat Rooms
  function displayChatRooms(chatRooms) {
    chatRoomsContainer.innerHTML = '<h2>Your Chat Rooms</h2>';

    Object.entries(chatRooms).forEach(([chatRoomId, metaData]) => {
      const roomElement = document.createElement('div');
      roomElement.className = 'room-item';
      roomElement.textContent = `Room ID: ${chatRoomId}, Last Message: ${metaData.lastMessage}, Unread: ${metaData.unreadCount}`;

      // 채팅방 클릭 시 메시지 로드 및 WebSocket 연결
      roomElement.addEventListener('click', () => {
        chatRoomNumber = chatRoomId; // 활성화된 채팅방 설정
        chatRoomNumberSpan.textContent = chatRoomId; // 화면에 표시
        chatContainer.style.display = 'block'; // 채팅창 표시
        loadChatMessages(chatRoomId); // 메시지 로드
      });

      chatRoomsContainer.appendChild(roomElement);

      // WebSocket 연결 설정
      connectToWebSocketForRoom(chatRoomId);
    });
  }

  // WebSocket 연결 및 메시지 구독
  function connectToWebSocketForRoom(chatRoomId) {
    const socket = new SockJS(`/ws?roomId=${chatRoomId}`);
    const client = Stomp.over(socket);

    client.connect({}, frame => {
      console.log(`Connected to WebSocket for room ${chatRoomId}:`, frame);

      // Subscribe to room's topic
      client.subscribe(`/topic/chat/${chatRoomId}`, message => {
        const chatMessageInfo = JSON.parse(message.body);
        displayNewMessageForRoom(chatRoomId, chatMessageInfo);
      });

      updateStatus(`Connected to WebSocket for room ${chatRoomId}.`, true);
    }, error => {
      console.error(`Error connecting to WebSocket for room ${chatRoomId}:`, error);
      updateStatus(`Failed to connect to WebSocket for room ${chatRoomId}.`);
    });

    stompClients[chatRoomId] = client; // WebSocket 클라이언트 저장
  }
  // Load Chat Messages
  function loadChatMessages(chatRoomId) {
    // API 요청 URL 생성
    const apiUrl = `/api/v1/chat/message?senderEmail=${caregiverInfoInput.value}&receiverEmail=${entrustedInfoInput.value}&chatRoomId=${chatRoomId}&pageSize=10`;

    fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
              if (data.responseCode === "SUCCESS") {
                const chatResponse = data.result; // ChatMessageResponse 구조

                // _id, chatMessage, other 사용
                if (chatResponse && chatResponse.chatMessage) {
                  displayChatMessages(chatResponse.chatMessage);
                  updateStatus(`Loaded messages for room ${chatResponse._id}`, true);
                } else {
                  updateStatus('No messages found.');
                }
              } else {
                updateStatus(`Failed to load messages: ${data.responseCode}`);
              }
            })
            .catch(error => {
              console.error('Error loading messages:', error);
              updateStatus('Error loading messages.');
            });
  }

  // Display Chat Messages
  function displayChatMessages(messages) {
    chatMessageInfos.value = ''; // 기존 메시지 초기화
    messages.forEach(message => {
      const formattedMessage = `[${message.senderEmail}] ${message.msg} (${message.msgTimestamp})`;
      chatMessageInfos.value += `${formattedMessage}\n`;
    });
    chatMessageInfos.scrollTop = chatMessageInfos.scrollHeight; // 스크롤 맨 아래로
  }
  function displayNewMessageForRoom(chatRoomId, chatMessageInfo) {
    if (chatRoomNumber === chatRoomId) {
      chatMessageInfos.value += `[${chatMessageInfo.senderIdEmail}]: ${chatMessageInfo.msg}\n`;
      chatMessageInfos.scrollTop = chatMessageInfos.scrollHeight;
    } else {
      console.log(`New message for room ${chatRoomId}:`, chatMessageInfo);
    }
  }


  // Send Message
  sendMessageBtn.addEventListener('click', () => {
    const content = messageInput.value.trim();
    if (!content) {
      updateStatus('Please enter a message!');
      return;
    }

    const client = stompClients[chatRoomNumber];
    if (client) {
      client.send(`/app/chat`, {}, JSON.stringify({
        chatRoomId: chatRoomNumber,
        senderEmail: caregiverInfoInput.value.trim(),
        receiverEmail: entrustedInfoInput.value.trim(),
        msg: content
      }));

      messageInput.value = '';
    } else {
      updateStatus('No active WebSocket connection for this room.');
    }
  });
</script>

</body>
</html>
